@{
    ViewData["Title"] = "Admin Panel";
    var isLocked = ViewBag.IsPredictionsLocked == true;
    var nextEvent = ViewBag.NextEvent as PulpMXFantasy.Contracts.ReadModels.EventReadModel;
}

<h1 class="page-title">Admin</h1>

@if (TempData["Info"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["Info"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- SignalR Connection Status -->
<div id="connectionStatus" class="alert alert-secondary mb-3" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
    <span id="connectionIcon">&#9679;</span> <span id="connectionText">Connecting...</span>
</div>

<div class="grid-2 mb-4">
    <!-- Data Import -->
    <div class="card">
        <div class="card-header">
            <h5>Import Data</h5>
        </div>
        <div class="card-body">
            <!-- Sync Next Event -->
            <form asp-action="SyncNextEvent" method="post" class="mb-4">
                <button type="submit" class="btn btn-success w-100">
                    Sync Next Event
                </button>
                <p class="form-text">Fetch upcoming event with rider data and handicaps</p>
            </form>

            <div class="divider"></div>

            <!-- Import Season -->
            <form asp-action="ImportSeason" method="post">
                <label class="form-label">Import Season</label>
                <select class="form-select mb-3" name="season" required>
                    <option value="">Select a season...</option>
                    <optgroup label="2026">
                        <option value="2026-supercross">2026 Supercross (3 events)</option>
                    </optgroup>
                    <optgroup label="2025">
                        <option value="2025-supercross">2025 Supercross (17 events)</option>
                        <option value="2025-motocross">2025 Motocross (11 events)</option>
                        <option value="2025-smx">2025 SuperMotocross (3 events)</option>
                    </optgroup>
                    <optgroup label="2024">
                        <option value="2024-supercross">2024 Supercross (17 events)</option>
                        <option value="2024-motocross">2024 Motocross (11 events)</option>
                        <option value="2024-smx">2024 SuperMotocross (3 events)</option>
                    </optgroup>
                </select>
                <button type="submit" class="btn btn-primary w-100">
                    Import Season
                </button>
            </form>
        </div>
    </div>

    <!-- ML Training -->
    <div class="card @(isLocked ? "training-card is-locked" : "training-card")">
        <div class="card-body">
            @if (isLocked)
            {
                <svg class="training-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <h3 class="training-title" style="color: var(--color-danger);">Training Locked</h3>
            }
            else
            {
                <svg class="training-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <h3 class="training-title">Train Models</h3>
            }

            @if (nextEvent != null)
            {
                <p class="training-subtitle">
                    <strong>@nextEvent.Name</strong><br>
                    @if (nextEvent.LockoutTime.HasValue)
                    {
                        @if (isLocked)
                        {
                            <span>Locked at <span class="local-time" data-utc="@nextEvent.LockoutTime.Value.UtcDateTime.ToString("o")"></span></span>
                        }
                        else
                        {
                            <span>Locks at <span class="local-time" data-utc="@nextEvent.LockoutTime.Value.UtcDateTime.ToString("o")"></span></span>
                        }
                    }
                </p>
            }

            <p class="text-muted mb-4" style="font-size: 0.875rem;">
                @if (isLocked)
                {
                    <text>Training disabled during race to protect predictions.</text>
                }
                else
                {
                    <text>Trains 4 LightGBM models. Takes 1-5 minutes.</text>
                }
            </p>

            @if (isLocked)
            {
                <button type="button" class="btn btn-outline-danger w-100" disabled>
                    Train Models
                </button>
            }
            else
            {
                <form asp-action="TrainModels" method="post">
                    <button type="submit" class="btn btn-warning w-100">
                        Train Models
                    </button>
                </form>
            }
        </div>
    </div>
</div>

<!-- Command Status -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Command Status</h5>
        <span class="badge bg-secondary" id="commandCount">@(ViewBag.RecentStatuses != null ? ((IEnumerable<dynamic>)ViewBag.RecentStatuses).Count() : 0)</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="commandTable">
                <thead>
                    <tr>
                        <th>Command</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody id="commandTableBody">
                    @if (ViewBag.RecentStatuses != null && ((IEnumerable<dynamic>)ViewBag.RecentStatuses).Any())
                    {
                        @foreach (var status in ViewBag.RecentStatuses)
                        {
                            <tr class="command-row" data-command-id="@status.CommandId" style="cursor: pointer;">
                                <td><span style="font-size: 0.8125rem;">@status.CommandType</span></td>
                                <td>
                                    @if (status.Status == "Completed")
                                    {
                                        <span class="badge bg-success">@status.Status</span>
                                    }
                                    else if (status.Status == "Failed")
                                    {
                                        <span class="badge bg-danger">@status.Status</span>
                                    }
                                    else if (status.Status == "Running")
                                    {
                                        <span class="badge bg-primary">@status.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@status.Status</span>
                                    }
                                </td>
                                <td>
                                    @if (status.Status == "Running" || status.Status == "Pending")
                                    {
                                        <div class="progress" style="height: 20px; min-width: 80px;">
                                            <div class="progress-bar" role="progressbar" style="width: @(status.ProgressPercentage)%;">@(status.ProgressPercentage)%</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span style="font-size: 0.8125rem;">@(status.ProgressPercentage)%</span>
                                    }
                                </td>
                                <td>
                                    <span class="local-time" style="font-size: 0.8125rem;" data-utc="@status.StartedAt.UtcDateTime.ToString("o")" data-format="datetime"></span>
                                </td>
                                <td>
                                    @if (status.DurationMs != null)
                                    {
                                        <span style="font-size: 0.8125rem;">@FormatDuration((long)status.DurationMs)</span>
                                    }
                                    else if (status.CompletedAt != null)
                                    {
                                        var duration = ((DateTimeOffset)status.CompletedAt - (DateTimeOffset)status.StartedAt).TotalMilliseconds;
                                        <span style="font-size: 0.8125rem;">@FormatDuration((long)duration)</span>
                                    }
                                    else
                                    {
                                        <span style="font-size: 0.8125rem;">-</span>
                                    }
                                </td>
                                <td><span style="font-size: 0.8125rem;">@status.ProgressMessage</span></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="noCommandsRow">
                            <td colspan="6" class="text-muted" style="font-size: 0.875rem;">No recent commands</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="quick-actions">
    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Back to Dashboard</a>
    <a asp-controller="Predictions" asp-action="Index" class="btn btn-outline-primary">View Predictions</a>
</div>

<!-- Slide-out Panel for Command Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="commandDetailsPanel" aria-labelledby="commandDetailsPanelLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="commandDetailsPanelLabel">Command Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="commandDetailsLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="commandDetailsContent" style="display: none;">
            <!-- Command Info -->
            <div class="mb-4">
                <h6 class="text-muted mb-2">Command Info</h6>
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Type</small>
                                <div id="detailCommandType" style="font-weight: 500;"></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Status</small>
                                <div id="detailStatus"></div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Started</small>
                                <div id="detailStartedAt" style="font-size: 0.875rem;"></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Duration</small>
                                <div id="detailDuration" style="font-size: 0.875rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Timeline -->
            <div class="mb-4">
                <h6 class="text-muted mb-2">Progress Timeline</h6>
                <div id="progressTimeline" class="timeline">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>

            <!-- Result Data (expandable) -->
            <div id="resultDataSection" style="display: none;">
                <h6 class="text-muted mb-2">Result Data</h6>
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <pre id="resultDataContent" style="font-size: 0.75rem; max-height: 200px; overflow: auto; margin: 0;"></pre>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorSection" style="display: none;">
                <h6 class="text-muted mb-2">Error</h6>
                <div class="alert alert-danger mb-0">
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        // =====================================================================
        // SIGNALR CONNECTION
        // =====================================================================
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/admin")
            .withAutomaticReconnect([0, 1000, 5000, 10000, 30000])
            .configureLogging(signalR.LogLevel.Information)
            .build();

        let currentCommandId = null;
        let offcanvas = null;

        // Connection state handling
        function updateConnectionStatus(status, color) {
            const statusEl = document.getElementById('connectionStatus');
            const iconEl = document.getElementById('connectionIcon');
            const textEl = document.getElementById('connectionText');

            statusEl.className = `alert alert-${color} mb-3`;
            statusEl.style.padding = '0.5rem 1rem';
            statusEl.style.fontSize = '0.875rem';
            textEl.textContent = status;
        }

        connection.onreconnecting(() => {
            updateConnectionStatus('Reconnecting...', 'warning');
        });

        connection.onreconnected(() => {
            updateConnectionStatus('Connected (live updates)', 'success');
            connection.invoke('JoinAdminGroup');
        });

        connection.onclose(() => {
            updateConnectionStatus('Disconnected', 'danger');
        });

        // =====================================================================
        // SIGNALR EVENT HANDLERS
        // =====================================================================

        // Command Started
        connection.on("CommandStarted", (data) => {
            console.log('CommandStarted', data);
            addOrUpdateCommandRow(data.commandId, {
                commandType: data.commandType,
                status: 'Running',
                progressPercentage: 0,
                startedAt: data.startedAt,
                progressMessage: 'Starting...'
            });
        });

        // Command Progress
        connection.on("CommandProgress", (data) => {
            console.log('CommandProgress', data);
            updateCommandRow(data.commandId, {
                status: 'Running',
                progressPercentage: data.progressPercentage,
                progressMessage: data.progressMessage
            });

            // Update timeline if panel is open for this command
            if (currentCommandId === data.commandId) {
                addTimelineItem({
                    message: data.progressMessage,
                    progressPercentage: data.progressPercentage,
                    occurredAt: data.updatedAt,
                    milestoneName: data.milestoneName
                });
            }
        });

        // Command Completed
        connection.on("CommandCompleted", (data) => {
            console.log('CommandCompleted', data);
            updateCommandRow(data.commandId, {
                status: 'Completed',
                progressPercentage: 100,
                completedAt: data.completedAt,
                progressMessage: data.completionMessage,
                durationMs: data.durationMs
            });

            if (currentCommandId === data.commandId) {
                updatePanelStatus('Completed', data.durationMs);
                addTimelineItem({
                    message: data.completionMessage || 'Completed',
                    progressPercentage: 100,
                    occurredAt: data.completedAt,
                    milestoneName: 'Complete'
                });
            }
        });

        // Command Failed
        connection.on("CommandFailed", (data) => {
            console.log('CommandFailed', data);
            updateCommandRow(data.commandId, {
                status: 'Failed',
                completedAt: data.failedAt,
                progressMessage: data.errorMessage,
                durationMs: data.durationMs
            });

            if (currentCommandId === data.commandId) {
                updatePanelStatus('Failed', data.durationMs);
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = data.errorMessage;
            }
        });

        // =====================================================================
        // TABLE UPDATE FUNCTIONS
        // =====================================================================

        function addOrUpdateCommandRow(commandId, data) {
            const tbody = document.getElementById('commandTableBody');
            let row = tbody.querySelector(`tr[data-command-id="${commandId}"]`);

            // Remove "no commands" row if exists
            const noCommandsRow = document.getElementById('noCommandsRow');
            if (noCommandsRow) noCommandsRow.remove();

            if (!row) {
                row = document.createElement('tr');
                row.className = 'command-row';
                row.dataset.commandId = commandId;
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => showCommandDetails(commandId));

                // Insert at top
                tbody.insertBefore(row, tbody.firstChild);

                // Update count
                const countEl = document.getElementById('commandCount');
                countEl.textContent = parseInt(countEl.textContent) + 1;
            }

            row.innerHTML = `
                <td><span style="font-size: 0.8125rem;">${data.commandType}</span></td>
                <td>${getStatusBadge(data.status)}</td>
                <td>${getProgressCell(data.status, data.progressPercentage)}</td>
                <td><span style="font-size: 0.8125rem;">${formatDateTime(data.startedAt)}</span></td>
                <td><span style="font-size: 0.8125rem;">${data.durationMs ? formatDuration(data.durationMs) : '-'}</span></td>
                <td><span style="font-size: 0.8125rem;">${data.progressMessage || ''}</span></td>
            `;
        }

        function updateCommandRow(commandId, data) {
            const row = document.querySelector(`tr[data-command-id="${commandId}"]`);
            if (!row) return;

            // Update status badge
            if (data.status) {
                row.cells[1].innerHTML = getStatusBadge(data.status);
            }

            // Update progress
            if (data.progressPercentage !== undefined) {
                row.cells[2].innerHTML = getProgressCell(data.status, data.progressPercentage);
            }

            // Update duration
            if (data.durationMs) {
                row.cells[4].innerHTML = `<span style="font-size: 0.8125rem;">${formatDuration(data.durationMs)}</span>`;
            }

            // Update message
            if (data.progressMessage) {
                row.cells[5].innerHTML = `<span style="font-size: 0.8125rem;">${data.progressMessage}</span>`;
            }
        }

        function getStatusBadge(status) {
            const colors = {
                'Completed': 'success',
                'Failed': 'danger',
                'Running': 'primary',
                'Pending': 'secondary'
            };
            return `<span class="badge bg-${colors[status] || 'secondary'}">${status}</span>`;
        }

        function getProgressCell(status, percentage) {
            if (status === 'Running' || status === 'Pending') {
                return `<div class="progress" style="height: 20px; min-width: 80px;">
                    <div class="progress-bar" role="progressbar" style="width: ${percentage}%;">${percentage}%</div>
                </div>`;
            }
            return `<span style="font-size: 0.8125rem;">${percentage}%</span>`;
        }

        // =====================================================================
        // SLIDE-OUT PANEL
        // =====================================================================

        async function showCommandDetails(commandId) {
            currentCommandId = commandId;

            // Show panel
            const panelEl = document.getElementById('commandDetailsPanel');
            offcanvas = new bootstrap.Offcanvas(panelEl);
            offcanvas.show();

            // Show loading
            document.getElementById('commandDetailsLoading').style.display = 'block';
            document.getElementById('commandDetailsContent').style.display = 'none';

            try {
                const response = await fetch(`/Admin/GetCommandDetails?commandId=${commandId}`);
                if (!response.ok) throw new Error('Failed to load');

                const data = await response.json();
                displayCommandDetails(data);
            } catch (error) {
                console.error('Error loading command details:', error);
            }

            // Clear on close
            panelEl.addEventListener('hidden.bs.offcanvas', () => {
                currentCommandId = null;
            }, { once: true });
        }

        function displayCommandDetails(data) {
            document.getElementById('commandDetailsLoading').style.display = 'none';
            document.getElementById('commandDetailsContent').style.display = 'block';

            // Command info
            document.getElementById('detailCommandType').textContent = data.commandType;
            document.getElementById('detailStatus').innerHTML = getStatusBadge(data.status);
            document.getElementById('detailStartedAt').textContent = formatDateTimeFull(data.startedAt);
            document.getElementById('detailDuration').textContent = data.durationMs ? formatDuration(data.durationMs) : '-';

            // Timeline
            const timeline = document.getElementById('progressTimeline');
            timeline.innerHTML = '';

            if (data.history && data.history.length > 0) {
                data.history.forEach(item => addTimelineItem(item));
            }

            // Result data
            if (data.resultData) {
                document.getElementById('resultDataSection').style.display = 'block';
                try {
                    const parsed = JSON.parse(data.resultData);
                    document.getElementById('resultDataContent').textContent = JSON.stringify(parsed, null, 2);
                } catch {
                    document.getElementById('resultDataContent').textContent = data.resultData;
                }
            } else {
                document.getElementById('resultDataSection').style.display = 'none';
            }

            // Error
            if (data.errorMessage) {
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = data.errorMessage;
            } else {
                document.getElementById('errorSection').style.display = 'none';
            }
        }

        function addTimelineItem(item) {
            const timeline = document.getElementById('progressTimeline');

            const div = document.createElement('div');
            div.className = 'timeline-item';
            div.innerHTML = `
                <div class="timeline-marker" style="background: ${item.progressPercentage === 100 ? '#198754' : '#0d6efd'};"></div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        ${item.milestoneName ? `<span class="badge bg-secondary me-2">${item.milestoneName}</span>` : ''}
                        <span class="text-muted" style="font-size: 0.75rem;">${formatTime(item.occurredAt)}</span>
                    </div>
                    <div class="timeline-message">${item.message}</div>
                    <div class="timeline-progress text-muted" style="font-size: 0.75rem;">${item.progressPercentage}%</div>
                </div>
            `;
            timeline.appendChild(div);
            timeline.scrollTop = timeline.scrollHeight;
        }

        function updatePanelStatus(status, durationMs) {
            document.getElementById('detailStatus').innerHTML = getStatusBadge(status);
            if (durationMs) {
                document.getElementById('detailDuration').textContent = formatDuration(durationMs);
            }
        }

        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================

        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTimeFull(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'medium' });
        }

        function formatDuration(ms) {
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}m ${seconds}s`;
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        document.addEventListener('DOMContentLoaded', async function() {
            // Format local times
            document.querySelectorAll('.local-time').forEach(function(el) {
                const utc = el.dataset.utc;
                if (!utc) return;

                const date = new Date(utc);
                const format = el.dataset.format;

                if (format === 'time') {
                    el.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                } else if (format === 'datetime') {
                    el.textContent = date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                } else {
                    el.textContent = date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
                }
            });

            // Add click handlers to existing rows
            document.querySelectorAll('.command-row').forEach(row => {
                row.addEventListener('click', () => {
                    const commandId = row.dataset.commandId;
                    showCommandDetails(commandId);
                });
            });

            // Start SignalR connection
            try {
                await connection.start();
                updateConnectionStatus('Connected (live updates)', 'success');
                await connection.invoke('JoinAdminGroup');
            } catch (err) {
                console.error('SignalR connection failed:', err);
                updateConnectionStatus('Failed to connect', 'danger');
            }
        });
    </script>
}

@functions {
    string FormatDuration(long ms)
    {
        if (ms < 1000) return $"{ms}ms";
        if (ms < 60000) return $"{(ms / 1000.0):F1}s";
        var minutes = ms / 60000;
        var seconds = (ms % 60000) / 1000;
        return $"{minutes}m {seconds}s";
    }
}
